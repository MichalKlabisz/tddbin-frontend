<!DOCTYPE html>
<html lang="en">
<head>
  <title></title>
  <meta charset="utf-8">
  <script src="../node_modules/requirejs/require.js"></script>
</head>
<body>

  <h1>The embedded jasmine runner</h1>

  <div>
    <button onclick="postPassingTest()">Run passing test</button>
    <button onclick="postFailingTest()">Run failing test</button>
    <button onclick="postManyTests()">Run many tests</button>
  </div>

  <div id="embeddedMocha"></div>

  <script type="application/javascript">
    require.config({
      baseUrl: '../',
      paths: {
        react: 'node_modules/react/dist/react',
        JSXTransformer: 'vendor/jsx-requirejs-plugin/js/JSXTransformer-0.11.0',
        jsx: 'vendor/jsx-requirejs-plugin/js/jsx',
        text: 'vendor/jsx-requirejs-plugin/js/text'
      }
    });

    require(['react', 'jsx!src/embedded-mocha/embedded-mocha'], function(React, Mocha) {
      React.renderComponent(
        Mocha(),
        document.getElementById('embeddedMocha')
      );
    });

    var testSpecs = {
      simplePassing: "describe('test embedded mocha', function() {\
          it('should run', function() {\
            expect(1)\
              .toBe(1);\
          });\
        });",
      simpleFailing: "describe('test embedded mocha', function() {\
          it('should fail', function() {\
            expect(1)\
              .toBe(2);\
          });\
        });"
    };

    function postPassingTest() {
      _postTestSourceCode(testSpecs.simplePassing);
    }

    function postFailingTest() {
      _postTestSourceCode(testSpecs.simpleFailing);
    }

    function postManyTests() {
      _postTestSourceCode([
        testSpecs.simplePassing,
        testSpecs.simplePassing,
        testSpecs.simplePassing,
        testSpecs.simpleFailing,
        testSpecs.simpleFailing,
        testSpecs.simplePassing
      ].join('\n'));
    }

    function _postTestSourceCode(sourceCode) {
      var iframe = document.getElementById('embeddedJasmine').contentWindow;
      iframe.postMessage(sourceCode, '*');
    }

    window.addEventListener('message', receiveRunnerData, false);
    function receiveRunnerData(data) {
      var stats = data.data;
      console.log(stats);
    }
  </script>

</body>
</html>

